<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Insurance Flow - D3.js Network Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px 40px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 100;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 5px;
            font-weight: 700;
        }

        header p {
            font-size: 1em;
            opacity: 0.9;
        }

        #graph {
            flex: 1;
            position: relative;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .controls h3 {
            margin-bottom: 15px;
            color: #1e3c72;
            font-size: 1.2em;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #4a5568;
            font-size: 0.9em;
            font-weight: 600;
        }

        .control-group button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .control-group button:hover {
            transform: scale(1.05);
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .legend h3 {
            margin-bottom: 15px;
            color: #1e3c72;
            font-size: 1.2em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .legend-label {
            color: #4a5568;
            font-size: 0.9em;
        }

        .node-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            pointer-events: none;
            font-size: 0.9em;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            max-width: 300px;
        }

        .tooltip-title {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 8px;
            color: #67e8f9;
        }

        .tooltip-content {
            line-height: 1.6;
        }

        .tooltip-endpoint {
            background: rgba(255,255,255,0.1);
            padding: 5px 10px;
            border-radius: 6px;
            margin-top: 8px;
            font-family: 'Monaco', monospace;
            font-size: 0.85em;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .link {
            stroke-opacity: 0.6;
            stroke-width: 3;
        }

        .link-label {
            font-size: 11px;
            fill: white;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 0 8px rgba(0,0,0,0.8);
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            filter: brightness(1.3);
        }

        .node-label {
            font-size: 13px;
            font-weight: 600;
            fill: white;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(0,0,0,0.8);
        }

        .node-sublabel {
            font-size: 10px;
            fill: rgba(255,255,255,0.8);
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 0 8px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåê Auto Insurance API Network Graph</h1>
            <p>Interactive D3.js force-directed visualization showing data flow and relationships</p>
        </header>

        <div id="graph"></div>

        <div class="controls">
            <h3>‚öôÔ∏è Controls</h3>
            <div class="control-group">
                <button onclick="restartSimulation()">üîÑ Restart Animation</button>
            </div>
            <div class="control-group">
                <button onclick="freezeSimulation()">‚ùÑÔ∏è Freeze/Unfreeze</button>
            </div>
            <div class="control-group">
                <button onclick="resetZoom()">üîç Reset Zoom</button>
            </div>
        </div>

        <div class="legend">
            <h3>üé® Node Types</h3>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                <span class="legend-label">API Endpoints</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #f093fb, #f5576c);"></div>
                <span class="legend-label">Data Entities</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #4facfe, #00f2fe);"></div>
                <span class="legend-label">External Services</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: linear-gradient(135deg, #43e97b, #38f9d7);"></div>
                <span class="legend-label">Payment Gateway</span>
            </div>
        </div>
    </div>

    <script>
        const width = window.innerWidth;
        const height = window.innerHeight - 70; // Subtract header height

        // Data structure
        const data = {
            nodes: [
                // API Endpoints
                { id: 'drivers-api', label: 'Drivers API', sublabel: 'POST /drivers', type: 'api', color: '#667eea', endpoint: 'POST /api/v1/insurance/drivers' },
                { id: 'vehicles-api', label: 'Vehicles API', sublabel: 'POST /vehicles', type: 'api', color: '#667eea', endpoint: 'POST /api/v1/insurance/vehicles' },
                { id: 'quotes-api', label: 'Quotes API', sublabel: 'POST /quotes', type: 'api', color: '#667eea', endpoint: 'POST /api/v1/insurance/quotes' },
                { id: 'policies-api', label: 'Policies API', sublabel: 'POST /policies', type: 'api', color: '#667eea', endpoint: 'POST /api/v1/insurance/policies' },
                { id: 'manage-api', label: 'Management API', sublabel: 'GET /policies/{id}', type: 'api', color: '#667eea', endpoint: 'GET /api/v1/insurance/policies/{id}' },

                // Data Entities
                { id: 'driver-data', label: 'Driver Records', sublabel: 'Personal Info', type: 'data', color: '#f093fb' },
                { id: 'vehicle-data', label: 'Vehicle Records', sublabel: 'VIN Details', type: 'data', color: '#f093fb' },
                { id: 'quote-data', label: 'Quote Results', sublabel: 'Multi-Carrier', type: 'data', color: '#f093fb' },
                { id: 'policy-data', label: 'Active Policies', sublabel: 'Coverage Details', type: 'data', color: '#f093fb' },

                // External Services
                { id: 'vin-service', label: 'VIN Database', sublabel: 'NHTSA API', type: 'external', color: '#4facfe' },
                { id: 'progressive', label: 'Progressive', sublabel: 'Carrier API', type: 'external', color: '#4facfe' },
                { id: 'geico', label: 'GEICO', sublabel: 'Carrier API', type: 'external', color: '#4facfe' },
                { id: 'statefarm', label: 'State Farm', sublabel: 'Carrier API', type: 'external', color: '#4facfe' },

                // Payment
                { id: 'stripe', label: 'Stripe', sublabel: 'Payment Gateway', type: 'payment', color: '#43e97b' },

                // User
                { id: 'mobile-app', label: 'Mobile App', sublabel: 'User Interface', type: 'user', color: '#fa709a', size: 50 }
            ],
            links: [
                // User to APIs
                { source: 'mobile-app', target: 'drivers-api', label: 'Add Driver' },
                { source: 'mobile-app', target: 'vehicles-api', label: 'Add Vehicle' },
                { source: 'mobile-app', target: 'quotes-api', label: 'Request Quote' },
                { source: 'mobile-app', target: 'policies-api', label: 'Purchase' },
                { source: 'mobile-app', target: 'manage-api', label: 'View/Update' },

                // APIs to Data
                { source: 'drivers-api', target: 'driver-data', label: 'Store' },
                { source: 'vehicles-api', target: 'vehicle-data', label: 'Store' },
                { source: 'quotes-api', target: 'quote-data', label: 'Store' },
                { source: 'policies-api', target: 'policy-data', label: 'Store' },

                // VIN Lookup
                { source: 'vehicles-api', target: 'vin-service', label: 'Decode VIN' },

                // Quote Flow
                { source: 'quotes-api', target: 'driver-data', label: 'Read' },
                { source: 'quotes-api', target: 'vehicle-data', label: 'Read' },
                { source: 'quotes-api', target: 'progressive', label: 'Get Quote' },
                { source: 'quotes-api', target: 'geico', label: 'Get Quote' },
                { source: 'quotes-api', target: 'statefarm', label: 'Get Quote' },

                // Policy Purchase
                { source: 'policies-api', target: 'quote-data', label: 'Read' },
                { source: 'policies-api', target: 'progressive', label: 'Bind Policy' },
                { source: 'policies-api', target: 'stripe', label: 'Setup Auto-pay' },

                // Management
                { source: 'manage-api', target: 'policy-data', label: 'Query' },
                { source: 'manage-api', target: 'driver-data', label: 'Query' },
                { source: 'manage-api', target: 'vehicle-data', label: 'Query' }
            ]
        };

        // Create SVG
        const svg = d3.select('#graph')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        const g = svg.append('g');

        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.5, 3])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Create tooltip
        const tooltip = d3.select('body')
            .append('div')
            .attr('class', 'node-tooltip')
            .style('opacity', 0)
            .style('display', 'none');

        // Create force simulation
        const simulation = d3.forceSimulation(data.nodes)
            .force('link', d3.forceLink(data.links).id(d => d.id).distance(150))
            .force('charge', d3.forceManyBody().strength(-400))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(60));

        // Create links
        const link = g.append('g')
            .selectAll('line')
            .data(data.links)
            .join('line')
            .attr('class', 'link')
            .attr('stroke', d => {
                // Color links based on source node type
                const sourceNode = data.nodes.find(n => n.id === d.source.id || n.id === d.source);
                return sourceNode ? sourceNode.color : '#999';
            });

        // Create link labels
        const linkLabel = g.append('g')
            .selectAll('text')
            .data(data.links)
            .join('text')
            .attr('class', 'link-label')
            .text(d => d.label);

        // Create nodes with gradients
        const defs = svg.append('defs');

        data.nodes.forEach((node, i) => {
            const gradient = defs.append('linearGradient')
                .attr('id', `gradient-${i}`)
                .attr('x1', '0%')
                .attr('y1', '0%')
                .attr('x2', '100%')
                .attr('y2', '100%');

            gradient.append('stop')
                .attr('offset', '0%')
                .attr('stop-color', node.color);

            gradient.append('stop')
                .attr('offset', '100%')
                .attr('stop-color', d3.color(node.color).darker(0.5));
        });

        const node = g.append('g')
            .selectAll('circle')
            .data(data.nodes)
            .join('circle')
            .attr('class', 'node')
            .attr('r', d => d.size || 40)
            .attr('fill', (d, i) => `url(#gradient-${i})`)
            .attr('stroke', '#fff')
            .attr('stroke-width', 3)
            .style('filter', 'drop-shadow(0 6px 16px rgba(0,0,0,0.4))')
            .on('mouseover', function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('r', (d.size || 40) * 1.2);

                let content = `<div class="tooltip-title">${d.label}</div>`;
                content += `<div class="tooltip-content">${d.sublabel}</div>`;
                if (d.endpoint) {
                    content += `<div class="tooltip-endpoint">${d.endpoint}</div>`;
                }

                tooltip.html(content)
                    .style('opacity', 1)
                    .style('display', 'block')
                    .style('left', (event.pageX + 15) + 'px')
                    .style('top', (event.pageY - 15) + 'px');
            })
            .on('mouseout', function(event, d) {
                d3.select(this)
                    .transition()
                    .duration(200)
                    .attr('r', d.size || 40);

                tooltip.style('opacity', 0)
                    .style('display', 'none');
            })
            .on('click', function(event, d) {
                console.log('Clicked node:', d);
            })
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended));

        // Node labels
        const nodeLabel = g.append('g')
            .selectAll('text')
            .data(data.nodes)
            .join('text')
            .attr('class', 'node-label')
            .attr('dy', -45)
            .text(d => d.label);

        const nodeSublabel = g.append('g')
            .selectAll('text')
            .data(data.nodes)
            .join('text')
            .attr('class', 'node-sublabel')
            .attr('dy', -30)
            .text(d => d.sublabel);

        // Update positions
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            linkLabel
                .attr('x', d => (d.source.x + d.target.x) / 2)
                .attr('y', d => (d.source.y + d.target.y) / 2);

            node
                .attr('cx', d => d.x)
                .attr('cy', d => d.y);

            nodeLabel
                .attr('x', d => d.x)
                .attr('y', d => d.y);

            nodeSublabel
                .attr('x', d => d.x)
                .attr('y', d => d.y);
        });

        // Drag functions
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        // Control functions
        let frozen = false;

        function restartSimulation() {
            simulation.alpha(1).restart();
        }

        function freezeSimulation() {
            if (frozen) {
                simulation.alpha(1).restart();
                frozen = false;
            } else {
                simulation.stop();
                frozen = true;
            }
        }

        function resetZoom() {
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity);
        }

        // Initial zoom to fit
        setTimeout(() => {
            const bounds = g.node().getBBox();
            const fullWidth = bounds.width;
            const fullHeight = bounds.height;
            const midX = bounds.x + fullWidth / 2;
            const midY = bounds.y + fullHeight / 2;

            const scale = 0.8 / Math.max(fullWidth / width, fullHeight / height);
            const translate = [width / 2 - scale * midX, height / 2 - scale * midY];

            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }, 1000);
    </script>
</body>
</html>
